variables:
  CONDASOURCE: "~/miniconda3/etc/profile.d/conda.sh"

jobs:
- job: 'Testing'
  displayName: 'Unit Testing With Programs'
  pool:
    name: qcengine
  timeoutInMinutes: 360
  strategy:
    matrix:
      Python36:
        python.version: '3.6'
      Python37:
        python.version: '3.7'
    maxParallel: 3

  steps:
      # Specify to use the python version defined above
#    - task: UsePythonVersion@0
#      inputs:
#        versionSpec: '$(python.version)'
#        architecture: 'x64'

      # Additional info about the build
    - script: |
        uname -a
        free -m
        df -h
        ulimit -a

    # Setup python environment
    - script: |
        WORKER=worker_test$PYTHON_VER
        source $(CONDASOURCE)
        # Create test environment for package
        conda env create -n $WORKER python=$PYTHON_VER -f devtools/conda-envs/psi.yaml
        conda activate $WORKER
        # Build and install package
        python setup.py develop --no-deps
      displayName: "Conda Env Creation"

    # Display MongoDB, Conda Environment, Python version
    - script: |
        sleep 5
        python -V
        conda list
        pwd
        ls -la
      displayName: 'Display'

    # Run tests
    - script: pytest -rsx -v --cov=qcengine/ qcengine/
      displayName: 'pytest'

    # Cleanup
    - script: |
        WORKER=worker_test$PYTHON_VER
        conda remove -n $WORKER --yes --all
      condition: always()
      failOnStderr: False
      displayName: "Conda Env Cleanup"